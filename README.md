# hiroshima

[広島水位予測コンペ](https://signate.jp/competitions/908)のリポジトリ

- result
  - 暫定評価 : 0.1066536
  - 最終評価 : 0.1378769
  - 順位 : 13/247
  
- ディレクトリ構成図（一部置いていないファイル、フォルダあり）
```
hiroshima
├── README.md
├── data             <---- 生データ or 加工済みデータ
├── model            <---- 作成したモデル
├── notebook         <---- jupyter lab で作業したノートブック
├── inference-test   <---- 推論の動作確認用
└── submit-folder    <---- 提出フォルダ
```


## 解法

### 1. 異常値修正

一部急激に水位が変化する観測所が存在したため、一部区間の補正や削除を実施。

白川や大谷池の異常値については「加工5.ipynb」を、  
その他観測所の水位の異常値については「EDA-水位外れ値.ipynb」を参照。   
補正や削除は「加工12.ipynb」参照

### 2. 水位データの場合分け
全166ヶ所の水位観測所のうち、7ヶ所の水位が潮の満ち引きに似た以下の周期になっていた。
（残りの159ヶ所は前日の23時のデータと強い相関があった）

**半日周期**

潮の満ち引きは月との引力(遠心力)で生じる。1日1回自転し、月と最も近づいた(遠ざかった)時に潮位が上がる  
=> 12時間前の水位データを使用

**半月周期**

月、地球、太陽が一直線に並ぶと引力が大きくなり、満潮と干潮の潮位差が大きくなる  
=> 15日前の水位の振幅を標準偏差で出す（結果入れてもあまり変わらなかった）

**年間周期**

夏は海水温が上昇し、海水が膨張して潮位が上がる。その他台風や気圧の影響もあるらしい

※今回は年間周期に関する特徴量入れない（テストデータが1年弱しかなさそう＋翌日予測には1年前のデータは重要ではないと判断）

[参考1](https://www.pref.kyoto.jp/shingikai/kasen-01/documents/sankou.pdf)

[参考2](https://www.city.miyakojima.lg.jp/kurashi/bousai/bousaijyouhou/bousaimemo/backnumber/41.html)

そのため、この7地点と残りの159地点の２パターンで分けて学習を行なった。

### 3. モデル作成

#### 前提
- ある日の166地点の水位データが入力として入り、その翌日の水位の予測をする。

- 入力、出力ともに1時間単位。

- 前述の通り、２パターンに分けてモデルを作成している。

#### 特徴量


| 特徴量名 | 説明 |
| ------------- | ------------- |
| 観測所名  | 166ヶ所をカテゴリ化  |
| 予測時間  | 0~23時をsin,cosで２次元に（朝、夜の分割をしやすくするため。ただあまり意味は無かったか）|

- 水位データ
  - 潮位0(159ヶ所)

| 使用日 | 使用した特徴量 |
| ------------- | ------------- |
| 当日 | h-23,22,21,18,15,12,6,0, min,max,mean,std,null_count |
| 1日前  | 6時間分平均、std,null_count |
| 2日前  | 12時間分平均,std,null_count |

  - 潮位1(7ヶ所)

| 使用日 | 使用した特徴量 |
| ------------- | ------------- |
| 当日 | (h-0~23)、12時間分平均、min,max,mean,std,null_count |
| 1日前  | (h-0~23)、12時間分平均、min,max,mean,std,null_count |
| 2日前  | 12時間分平均、min,max,mean,std,null_count |
| 3日前  | 12時間分平均、min,max,mean,std,null_count |
| 4日前  | mean,null_count |
| 5日前  | mean,null_count |
| 14日前  | std,null_count |
| 15日前  | std,null_count |
| 16日前  | std,null_count |

※null_countは24時間分の中で欠損の時間数

- 雨量データ
各水位観測所と近い雨量観測所を紐づけ。  

| 使用日 | 使用した特徴量 |
| ------------- | ------------- |
| 当日 | 24時間分のmean,12-14時のmeanとmax,15-17時のmeanとmax,18-20時のmeanとmax,21-23時のmeanとmax |
| 1日前  | 24時間分のmean |
| 2日前  | 24時間分のmean |

#### データ分割
trainデータは6年分あり、これを学習用、検証用に以下の4パターンに分けた。

1. 学習: 1~4年目 検証 : 5,6年目
2. 学習: 1~5年目 検証 : 6年目
3. 1~5年目でKfold(k=5)で、そこで得た1年分と6年目を検証に回す
4. 1~6年目でKfold(k=6)

最終的には4が一番テストデータでの精度が良かったので最終提出では採用。

#### モデル選択
- 今回はLightGBMを使用。
- catboost,xgboostも試みたが、精度が良く無かったため断念。
- Deep learningも欠損値の扱いに悩んだため断念。
- optunaによるパラメータチューニングも試みたが、かえってテストデータでのスコアが悪化したため、デフォルトパラメータで学習を実施した。




